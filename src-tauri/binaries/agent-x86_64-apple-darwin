#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# In dev mode, binaries are in src-tauri/binaries, sidecar is in project root/sidecar
SIDECAR_DIR="$SCRIPT_DIR/../../sidecar"
if [ ! -d "$SIDECAR_DIR" ]; then
  # Try relative to target/debug
  SIDECAR_DIR="$SCRIPT_DIR/../../../sidecar"
fi
cd "$SIDECAR_DIR"
needs_build=0
if [ ! -f "dist/agent.js" ]; then
  needs_build=1
else
  if find . -name "*.ts" -newer "dist/agent.js" | grep -q "."; then
    needs_build=1
  fi
fi

if [ "$needs_build" -eq 1 ]; then
  if command -v bun >/dev/null 2>&1; then
    bun run build >/dev/null 2>&1
  else
    npm run build >/dev/null 2>&1
  fi
fi
exec node dist/agent.js
